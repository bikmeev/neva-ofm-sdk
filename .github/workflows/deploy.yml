name: Sync to R2

on:
  push:
    branches: [main, dev]
    tags: ['v*']

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install Wrangler
        run: npm install -g wrangler
      
      - name: Determine path
        id: path
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            echo "folder=${VERSION}" >> $GITHUB_OUTPUT
          elif [[ $GITHUB_REF == refs/heads/main ]]; then
            echo "folder=latest" >> $GITHUB_OUTPUT
          elif [[ $GITHUB_REF == refs/heads/dev ]]; then
            echo "folder=latest-dev" >> $GITHUB_OUTPUT
          fi
      
      - name: Debug - Show files
        run: |
          echo "ğŸ“ Files in repository:"
          ls -lah
          echo ""
          echo "ğŸ“„ File to upload:"
          ls -lh neva-ofm.js
          echo ""
          echo "ğŸ” File size:"
          du -h neva-ofm.js
      
      - name: Upload to R2
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          FOLDER="${{ steps.path.outputs.folder }}"
          
          echo "=========================================="
          echo "ğŸš€ Starting upload to R2"
          echo "=========================================="
          echo "ğŸ“¦ Bucket: ${R2_BUCKET_NAME}"
          echo "ğŸ“‚ Folder: ${FOLDER}"
          echo "ğŸ“„ File: neva-ofm.js"
          echo "=========================================="
          
          wrangler r2 object put "${R2_BUCKET_NAME}/${FOLDER}/neva-ofm.js" \
            --file ./neva-ofm.js \
            --content-type "application/javascript" \
            --cache-control "public, max-age=3600"
          
          echo "âœ… Upload complete!"
          
          echo "ğŸ” Verifying..."
          wrangler r2 object get "${R2_BUCKET_NAME}/${FOLDER}/neva-ofm.js" --file /tmp/test.js --remote
          ls -lh /tmp/test.js
          echo "âœ… File verified in R2!"
