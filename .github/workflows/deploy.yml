name: Sync to R2

on:
  push:
    branches: [main, dev]
    tags: ['v*']

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install Wrangler
        run: npm install -g wrangler
      
      - name: Determine path
        id: path
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            echo "folder=${VERSION}" >> $GITHUB_OUTPUT
          elif [[ $GITHUB_REF == refs/heads/main ]]; then
            echo "folder=latest" >> $GITHUB_OUTPUT
          elif [[ $GITHUB_REF == refs/heads/dev ]]; then
            echo "folder=latest-dev" >> $GITHUB_OUTPUT
          fi
      
      - name: Debug info
        run: |
          echo "üìÅ Repository contents:"
          ls -lah
          echo ""
          echo "üìÑ File info:"
          ls -lh neva-ofm.js
          file neva-ofm.js
          echo ""
          echo "üìù First 5 lines:"
          head -5 neva-ofm.js
      
      - name: Upload to R2
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          FOLDER="${{ steps.path.outputs.folder }}"
          
          echo "=========================================="
          echo "üöÄ Uploading to R2"
          echo "=========================================="
          echo "Bucket:   ${R2_BUCKET_NAME}"
          echo "Path:     ${FOLDER}/neva-ofm.js"
          echo "File:     neva-ofm.js"
          echo "Size:     $(du -h neva-ofm.js | cut -f1)"
          echo "=========================================="
          echo ""
          
          wrangler r2 object put "${R2_BUCKET_NAME}/${FOLDER}/neva-ofm.js" \
            --file ./neva-ofm.js \
            --content-type "application/javascript" \
            --cache-control "public, max-age=3600"
          
          UPLOAD_STATUS=$?
          
          echo ""
          if [ $UPLOAD_STATUS -eq 0 ]; then
            echo "‚úÖ Upload successful!"
            echo ""
            echo "=========================================="
            echo "üìç File location:"
            echo "   Bucket: ${R2_BUCKET_NAME}"
            echo "   Path:   ${FOLDER}/neva-ofm.js"
            echo ""
            echo "üåê Access URLs:"
            echo "   R2 path: ${R2_BUCKET_NAME}/${FOLDER}/neva-ofm.js"
            echo "   Public:  https://pub-YOUR-ID.r2.dev/${FOLDER}/neva-ofm.js"
            echo "=========================================="
          else
            echo "‚ùå Upload failed with status: $UPLOAD_STATUS"
            exit 1
          fi
